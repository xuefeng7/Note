<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Xnote</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/stylish-portfolio.css" rel="stylesheet">
    <!-- shortcut icon -->
    <link rel="shortcut icon" href="https://maxcdn.icons8.com/Color/PNG/24/Messaging/note-24.png">
    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css"> 
    <!-- custom alert box -->
    <script src="sweetalert/dist/sweetalert.min.js"></script> 
    <link rel="stylesheet" type="text/css" href="sweetalert/dist/sweetalert.css">

    <link rel="stylesheet" href="css/style.css" media="screen" type="text/css" />

    <link href="css/profileStyle.css" rel="stylesheet">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


   <!--  style for the upload img chosen -->
    <style>
      .thumb {
        height: 120px;
        border: 1px solid #000;
        margin: 10px 5px 0 0;
      }
    </style>

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Welcome</a>
            
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li class="page-scroll">
                        <a href="#portfolio">Portfolio</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#about">About</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#services">Services</a>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-left">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li>
                        <div class = "smallImg">
                            <img class = "img-circle" src = "" id = "profileImg">
                        </div>
                    </li>
                    <li class="page-scroll">
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle js-activated" id = "userName" data-hover="dropdown" data-toggle="dropdown"></a>
                            <ul class="dropdown-menu">
                                <li> <!-- <a href="profile.html">Profile</a> -->
                                <!-- <input type="button" value = "Profile" class="btn btn-dark btn-lg" data-toggle="modal" id="profileButton"/> -->
                                <button type="button" class="btn btn-dark btn-lg" data-toggle="modal" id="profileButton">Profile</button>
                                   
                                </li>
                                <li>  <!--<a href="#">Log out</a> -->
                                    <!-- <input type="button" value = "Log out"class="btn btn-dark btn-lg" data-toggle="modal" style="height=20px;width=1000px;"id="logoutButton"/> -->
                                    <button type="button" class="btn btn-dark btn-lg" data-toggle="modal" id="logoutButton">Log out</button>
                                </li>
                            </ul>


                        </li>  
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Navigation 
    <a id="menu-toggle" href="#" class="btn btn-dark btn-lg toggle"><i class="fa fa-bars"></i></a>
    <nav id="sidebar-wrapper">
        <ul class="sidebar-nav">
            <a id="menu-close" href="#" class="btn btn-light btn-lg pull-right toggle"><i class="fa fa-times"></i></a>
            <li class="sidebar-brand">
                <a href="#top"  onclick = $("#menu-close").click(); >Xnote</a>
            </li>
            <li>
                <a href="#top" onclick = $("#menu-close").click(); >Home</a>
            </li>
            <li>
                <a href="#about" onclick = $("#menu-close").click(); >Log in</a>
            </li>
            <li>
                <a href="#services" onclick = $("#menu-close").click(); >Abount Us</a>
            </li>
        </ul>
    </nav>  -->

    <!-- Header -->
    <header id="top" class="header">
        <div class="text-vertical-center">

            <div class="row">
                <div class="col-md-3 col-sm-3">
                                       
                    <div class="user-wrapper">
                        <img src="" class="img-responsive" id="bigImg"/> <!-- 这里！！response profile photo -->

                    <div class="description">
                        <h6>Upload a different photo...</h6>

                        <input type="file" class="text-center center-block well well-sm" id="imgUploaded" name="files[]" accept="" ".png,.jpeg,.jpg"/> 
                        <output id="list"></output>
                        <!-- <img id="savedImg"src="" width="200" style="display:none;" /> -->

                         <!-- choose file part, UI still need inprovement-->
                         <!-- what kind of data does it return to browser? -->
                         <button type="submit" class="btn btn-primary js-submit" id="uploadImg">Upload</button>
                       <h4 class = "userName" id="leftUserName"></h4>  <!-- 这里！！user name -->
                        <h5 id = "leftAddress"> <strong></strong></h5>  <!-- 这里！！email -->
                        <p>
                            Course info
                        </p>
                        <hr />
                        <a href="#" class="btn btn-danger btn-sm"> <i class="fa fa-user-plus" ></i> &nbsp;Profile + </a> 
                    </div>
                     </div>
                </div>
                
                <div class="col-md-9 col-sm-9  user-wrapper">
                    <div class="description">
                         <h3> Account Info </h3>
                    <hr />
                     <form class="form-horizontal" role="form">
        <div class="form-group">
          <label class="col-lg-3 control-label">First name:</label> <!-- first name input -->
          <div class="col-lg-8">
            <input class="form-control" value="" type="text" id="fname">   
          </div>
        </div>
        <div class="form-group">
          <label class="col-lg-3 control-label">Last name:</label>  <!-- last name input -->
          <div class="col-lg-8">
            <input class="form-control" value="" type="text" id="lname">
          </div>
        </div>
    
        <div class="form-group">
          <label class="col-lg-3 control-label">Email:</label>  <!-- email input -->
          <div class="col-lg-8">
            <input class="form-control" value="" type="email" id="eaddress">
          </div>
        </div>
        <div class="form-group">
          <label class="col-lg-3 control-label">Acadamic Years</label>   <!-- aradamic year -->
          <div class="col-lg-8">
            <div class="ui-select">
              <select id="userYear" class="form-control">
                <option value="Freshmen">Freshmen</option>
                <option value="Sophomore">Sophomore</option>
                <option value="Junior">Junior</option>
                <option value="Senior">Senior</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="col-md-3 control-label">Change Password:</label>
          <div class="col-md-8">
            <input class="form-control" value="11111122333" type="password">
          </div>
        </div>
        <div class="form-group">
          <label class="col-md-3 control-label">Confirm password:</label>
          <div class="col-md-8">
            <input class="form-control" value="11111122333" type="password">
          </div>
        </div>
        <div class="form-group">
          <label class="col-md-3 control-label"></label>
          <div class="col-md-8">
            <input class="btn btn-primary" value="Save Changes" type="button" id="saveButton">
            <span></span>
            
          </div>
        </div>
      </form>

      <h3> Academic Info </h3>
      <hr />  

      <div class="[ form-group ]">
            <input type="checkbox" name="checkbox210" id="checkbox210" autocomplete="off" />
            <div class="[ btn-group ]">
                <label for="checkbox210" class="[ btn btn-primary ]">
                    <span class="[ glyphicon glyphicon-ok ]"></span>
                    <span> </span>
                </label>
                <label for="checkbox210" class="[ btn btn-default active ]">
                    CSC 210
                </label>

            </div>
        </div>
        <div class="[ form-group ]">
            <input type="checkbox" name="checkbox171" id="checkbox171" autocomplete="off" />
            <div class="[ btn-group ]">
                <label for="checkbox171" class="[ btn btn-info ]">
                    <span class="[ glyphicon glyphicon-ok ]"></span>
                    <span> </span>
                </label>
                <label for="checkbox171" class="[ btn btn-default active ]">
                    CSC 171
                </label>
            </div>
        </div>
        <div class="[ form-group ]">
            <input type="checkbox" name="checkbox172" id="checkbox172" autocomplete="off" />
            <div class="[ btn-group ]">
                <label for="checkbox172" class="[ btn btn-warning ]">
                    <span class="[ glyphicon glyphicon-ok ]"></span>
                    <span> </span>
                </label>
                <label for="checkbox172" class="[ btn btn-default active ]">
                    CSC 172
                </label>
            </div>
        </div>
        <div class="[ form-group ]">
            <input type="checkbox" name="checkbox173" id="checkbox173" autocomplete="off" />
            <div class="[ btn-group ]">
                <label for="checkbox173" class="[ btn btn-danger ]">
                    <span class="[ glyphicon glyphicon-ok ]"></span>
                    <span> </span>
                </label>
                <label for="checkbox173" class="[ btn btn-default active ]">
                    CSC 173
                </label>
            </div>
        </div>
        <div class="[ form-group ]">
            <input type="checkbox" name="checkbox240" id="checkbox240" autocomplete="off" />
            <div class="[ btn-group ]">
                <label for="checkbox240" class="[ btn btn-success ]">
                    <span class="[ glyphicon glyphicon-ok ]"></span>
                    <span> </span>
                </label>
                <label for="checkbox240" class="[ btn btn-default active ]">
                    CSC 240
                </label>
            </div>
        </div>

        <input type="checkbox" name="checkbox2_1" class="checkbox2" id="checkbox2_1"> <label for="checkbox2_1">Choice 1</label><br>
        <input type="checkbox" name="checkbox2_2" class="checkbox2" id="checkbox2_2"> <label for="checkbox2_2">Choice 2</label><br>
        <input type="checkbox" name="checkbox2_3" class="checkbox2" id="checkbox2_3"> <label for="checkbox2_3">Choice 3</label><br>
        <input type="checkbox" name="checkbox2_4" class="checkbox2" id="checkbox2_4"> <label for="checkbox2_4">Choice 4</label><br>
        <input class="btn btn-primary" value="Save Changes" type="button" id="saveAcademic">
        <!--<input value="destroy checkator" id="activate_checkator4" type="button"><br> -->



                    <h3> Social Links: </h3>
                    <hr />                
                   <a href="#" class="btn btn-social btn-facebook">
                            <i class="fa fa-facebook"></i>&nbsp; Facebook </a>

                        <a href="#" class="btn btn-social btn-google">
                            <i class="fa fa-google-plus"></i>&nbsp; Google</a>
                        <a href="#" class="btn btn-social btn-twitter">
                            <i class="fa fa-twitter"></i>&nbsp; Twitter </a>
                        <a href="#" class="btn btn-social btn-linkedin">
                            <i class="fa fa-linkedin"></i>&nbsp; Linkedin </a>
                    </div>
                 
                </div>
            </div>
            
    </header>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script>
    // Closes the sidebar menu
    $("#menu-close").click(function(e) {
        e.preventDefault();
        $("#sidebar-wrapper").toggleClass("active");
    });

    // Opens the sidebar menu
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#sidebar-wrapper").toggleClass("active");
    });

    // Scrolls to the selected menu item on the page
    $(function() {
        $('a[href*=#]:not([href=#])').click(function() {
            if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') || location.hostname == this.hostname) {

                var target = $(this.hash);
                target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
                if (target.length) {
                    $('html,body').animate({
                        scrollTop: target.offset().top
                    }, 1000);
                    return false;
                }
            }
        });
    });

    </script>
    
    <script type="text/javascript" src='js/fyll.js'></script>
    <script type="text/javascript" src='js/index.js'></script>




<!-- file choose handy functions -->
    <script>

    // global variable for storing the 64base info information for uploaded photo

    var global64 = "";

      function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object


        
        // Loop through the FileList and render image files as thumbnails.
        //for (var i = 0, f; f = files[i]; i++) {
           var f = files[0]; 

          // Only process image files.
          if (!f.type.match('image.*')) {
            return;
          }

          var reader = new FileReader();

          // Closure to capture the file information.
          reader.onload = (function(theFile) {
            return function(e) {
              // Render thumbnail.
              var span = document.createElement('span');
              console.log(e.target.result);
              global64 = e.target.result.replace(/^data:image\/(png|jpg|jpeg);base64,/g, "");
              span.innerHTML = ['<img class="thumb" src="', e.target.result,
                                '" title="', escape(theFile.name), '"/>'].join('');
              document.getElementById('list').innerHTML = '';
              document.getElementById('list').insertBefore(span, null);
            };
          })(f);

          // Read in the image file as a data URL.
          reader.readAsDataURL(f);
        //}
      }

    // here is the helping method for checking the chosen file's type *******
        function CheckFileName() {
            var fileName = document.getElementById("imgUploaded").value
            if (fileName == "") {
                swal("Browse to upload a valid File with png ot jpg extension");
                return false;
            }
            else if (fileName.split(".")[1].toUpperCase() == "PNG")
                return true;
            else if(fileName.split(".")[1].toUpperCase() == "JPG")
                return true;
            else{
                swal("File with " + fileName.split(".")[1] + " is invalid. Upload a validfile with png extensions");
                return false;
            }
            return true;
        }



    document.getElementById('imgUploaded').addEventListener('change', handleFileSelect, false);
    document.getElementById('imgUploaded').addEventListener('change', CheckFileName, false);

    // helping method to convert image file to 64base string
    function getBase64Image(img) {
        // Create an empty canvas element
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;

        // Copy the image contents to the canvas
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);

        // Get the data-URL formatted image
        // Firefox supports PNG and JPEG. You could check img.src to
        // guess the original format, but be aware the using "image/jpg"
        // will re-encode the image.
        var dataURL = canvas.toDataURL("image/png");

        return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
    }



</script>








       <!-- main part -->
    <script type = "text/javascript">
    
    //force non-https request to https
    //if (window.location.protocol != "https:"){

    //window.location.href = "https:" + window.location.href.substring(window.location.protocol.length);
    
    //}

    $(document).ready(function() {
      
      $.ajax({

        url: "/user?",
        type: "GET",

        success: function(data) {
                
                if (data === 'failed') {
                   console.log("fetch cached user failed.");
                }else{
                    //has cached user 
                    $("#userName").html(data['first_name']+" "+data['last_name']);
                    $("#leftUserName").html(data['first_name']+" "+data['last_name']);
                    $("#leftAddress").html(data['email']);
                    
                    $("#profileImg").attr('src',data['profile']['url']);
                    $("#bigImg").attr('src',data['profile']['url']);

                    // basic info shown
                    $("#fname").attr("value",data['first_name']);
                    $("#lname").attr("value",data['last_name']);
                    $("#eaddress").attr("value",data['email']);  // need to know the data corresponding name
                    $("#userYear").attr("value",data['year']);


                }
            }
      });      
      
      // user info change handler

      $("#saveButton").click(function(event) {
        //prevent the default redirect event
        event.preventDefault(); 
        $.ajax({

            url: "/update_profile/",     // what's the corresponding url ?
            type: "POST",
            dataType: "text",
            //encapuslate user sign up information
            data : {

                classyear: $("#userYear").val(),
                first_name: $("#fname").val(),
                last_name: $("#lname").val(),
                email: $("#eaddress").val()
                //password: $("#loginPassword").val()
            },

            success: function(data) {
    
                if (data[0] === '{') {
                    var user = $.parseJSON(data);
                    $("#userYear").attr("value", user['useryear']);
                    $("#fname").attr("value", user['first_name']);
                    $("#lname").attr("value", user['last_name']);
                    $("#eaddress").attr("value", user['email']);

                    $("#userName").html(user['first_name']+" "+user['last_name']);
                    $("#leftUserName").html(user['first_name']+" "+user['last_name']);
                    $("#leftAddress").html(user['email']);

                    swal("Saved", "You Profile has been updated successfully", "success")
                }else{
                    
                    swal("Save Profile Failed", data);
                }
            },
            error: function (jqXHR, exception) {
        var msg = '';
        if (jqXHR.status === 0) {
            msg = 'Not connect.\n Verify Network.';
        } else if (jqXHR.status == 404) {
            msg = 'Requested page not found. [404]';
        } else if (jqXHR.status == 500) {
            msg = 'Internal Server Error [500].';
        } else if (exception === 'parsererror') {
            msg = 'Requested JSON parse failed.';
        } else if (exception === 'timeout') {
            msg = 'Time out error.';
        } else if (exception === 'abort') {
            msg = 'Ajax request aborted.';
        } else {
            msg = 'Uncaught Error.\n' + jqXHR.responseText;
        }
       alert(msg);
    },
       
    });

      });
        

    //   update the profile Image by browsing local sourse 

    $("#uploadImg").click(function() {

        //console.log($("#imgUploaded")[0]);


        // $('#imgUploaded').change( function(event) {
        // var tmppath = URL.createObjectURL(event.target.files[0]);
        // console.log(URL.createObjectURL(event.target.files[0]));
        // $("savedImg").fadeIn("fast").attr('src',URL.createObjectURL(event.target.files[0]));
        // });
        //var f = $("#imgUploaded").name;
        //var fileUploadControl = f[0];
        //console.log(fileUploadControl);
        console.log(global64);

        if ($("#imgUploaded")[0].files.length > 0) {

            //var file = fileUploadControl.files[0];

            //console.log(file.name);
            var file64 = global64;
            console.log(file64);
              $.ajax({

                url: "/upload_Img/",
                type: "POST",
                dataType: "text",

                    //encapuslate user sign up information
                    data : {
                        profile: file64
                    },

                success: function(data) {
                        console.log(data);
                        if (data[0] == '{') {

                             //has cached user                                      
                            $("#profileImg").attr('src',data['profile']['url']);
                            $("#bigImg").attr('src',data['profile']['url']);
                           
                        }else{
                            console.log("updating profile failed");
                            swal("Upload Profile Failed", data);
                        }
                    }
              });      
              
              } else {

                swal("Before uploading, please choose a file", data);
              }    // for the case that the user didn't browse file locally but did click the upload button



    });

     $("#profileButton").click(function() {
          
          $.ajax({
            url: "/user?",
            type: "GET",
            success: function(data) {
                    
                    if (data === 'failed') {
                       console.log("fetch cached user failed. Not allow to go to userPage");
                    }else{
                        //move the browser to the userPage.html
                      console.log("User's session is valid, redirect");
                      window.location.replace("profile.html");
                    }
                }
          });
          });

    
        //  user log out  
        $("#logoutButton").click(function() {
          
          $.ajax({
            url: "/log_out/",
            type: "POST",
            success: function(data) {
                    
                    if (data === 'succeed') {
                          //move the browser to the userPage.html
                      console.log("successfully log out");
                       window.location = '/'; //redirect
                    }else{
                      console.log("fetch cached user failed. Not allow to go to userPage");
                    }
                }
          });  
        });

    }); // end of the document.ready

    </script>

</body>

</html>
